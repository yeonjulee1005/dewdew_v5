# Dewdew Portfolio v5 - Cursor Rules

## 프로젝트 개요
이 프로젝트는 Nuxt 4 기반의 포트폴리오 웹사이트로, AI 채팅 기능을 포함한 풀스택 애플리케이션입니다.

## 기술 스택
- **Framework**: Nuxt 4.2.1 (Vue 3 + SSR)
- **Language**: TypeScript 5.6.3
- **Styling**: Sass + Tailwind CSS + Nuxt UI 4.2.1 (커스텀 프리픽스: `Dd`)
- **State Management**: Pinia
- **Backend**: Supabase (PostgreSQL + Edge Functions)
- **AI**: OpenAI API (RAG 기반, @ai-sdk/openai)
- **Analytics**: Vercel Analytics + Speed Insights
- **PWA**: @vite-pwa/nuxt
- **Package Manager**: Bun

## 아키텍처 원칙

### 1. 컴포넌트 구조 (Atomic Design)
- `app/components/a/`: Atomic 컴포넌트 (재사용 가능한 기본 컴포넌트)
- `app/components/chat/`: AI 채팅 관련 컴포넌트
- `app/components/dynamic/card/`: 동적 렌더링 카드 컴포넌트 (AI 채팅에서 사용)
- `app/components/intro/`: 인트로 애니메이션 컴포넌트
- `.client.vue` / `.server.vue` 접미사로 클라이언트/서버 컴포넌트 명시

### 2. Composable 패턴
- 도메인별로 분리된 Composable 구조 유지
- 단일 책임 원칙 준수
- `use` 접두사 사용 (예: `useChat`, `useFormatter`)

### 3. 타입 시스템
- 도메인별 타입 파일 분리 (`app/types/`)
- Supabase 타입은 자동 생성:
  - `bun run supabase:type` - public 스키마
  - `bun run supabase:type-menu` - menu 스키마
  - `bun run supabase:type-resume` - resume 스키마
  - `bun run supabase:type-data` - data 스키마
- 제네릭 타입 활용으로 재사용성 향상

### 4. 스타일링 규칙
- Nuxt UI 컴포넌트는 `Dd` 프리픽스 사용 (예: `DdButton`, `DdChatMessages`)
- Tailwind CSS 유틸리티 클래스 우선 사용
- Sass는 글로벌 스타일 및 폰트에만 사용

## 코딩 컨벤션

### TypeScript
- 엄격한 타입 체크 활성화 (`shim: false`)
- `any` 타입 사용 최소화
- 인터페이스는 도메인별로 분리

### Vue 컴포넌트
- `<script setup lang="ts">` 사용
- Props는 `defineProps<T>()`로 타입 정의
- Emits는 `defineEmits<T>()`로 타입 정의
- 컴포넌트명은 PascalCase

### 파일 명명 규칙
- 컴포넌트: PascalCase (예: `Content.vue`)
- Composable: camelCase with `use` prefix (예: `useChat.ts`)
- 타입 파일: camelCase (예: `chat.ts`)
- 서버 파일: kebab-case (예: `index.post.ts`)

## AI 채팅 시스템

### 구조
- **클라이언트**: `app/composables/chat/useChat.ts` - 스트리밍 처리
- **서버**: `server/api/chat/index.post.ts` - API 엔드포인트
- **Edge Function**: `supabase/functions/dewdew-rag-portfolio/` - RAG 로직
- **공유 모듈**: `supabase/functions/_shared/` - 재사용 가능한 유틸리티

### 스트리밍 처리
- `ReadableStream` 기반 실시간 스트리밍
- `parseStreamResponse` 함수로 스트림 파싱
- 컴포넌트 타입은 `component-mapper.ts`에서 결정

### 성능 최적화
- 스트리밍 중 DOM 조작 최소화 (스크롤 방해 방지)
- `nextTick` 사용으로 DOM 업데이트 후 처리
- MutationObserver는 스트리밍 중 비활성화

### 벡터 검색 및 임베딩 관리
- **임베딩 초기화**: `initialize-embeddings` Edge Function으로 모든 문서의 임베딩 생성
- **중요**: `resume` 스키마의 데이터가 변경될 때마다 **반드시** `initialize-embeddings` Edge Function을 다시 invoke() 해야 함
  - 변경되는 테이블: profile, experience, skills, projects, education, hobbies, social_links, image_archive
  - 이유: 벡터 검색이 최신 데이터를 반영하려면 임베딩이 최신 상태여야 함
- **업데이트 방법**: Supabase Dashboard에서 Functions > initialize-embeddings > Invoke function
- **주의**: 데이터 변경 후 임베딩을 업데이트하지 않으면 벡터 검색 결과가 오래된 데이터를 반환할 수 있음
- **벡터 검색 방식**: 하이브리드 검색 (키워드 매칭 실패 시 의미 기반 벡터 검색 실행)

## 상태 관리

### Pinia Stores
- `app/stores/locationWeather.ts`: 위치 및 날씨 상태
- `app/stores/menu.ts`: 메뉴 상태
- `pinia-plugin-persistedstate`로 상태 영속화

## 다국어 지원

### i18n 구조
- `i18n/locales/ko.ts`: 한국어 번역
- `i18n/locales/en.ts`: 영어 번역
- `useI18n()` composable 사용
- 기본 언어: 한국어 (`defaultLocale: 'ko'`)

## API 구조

### 서버 API (`server/api/`)
- RESTful API 패턴 준수
- 파일명으로 HTTP 메서드 명시 (예: `index.post.ts`, `greeting.get.ts`)
- 타입 안전성 보장
- 구조:
  - `chat/`: AI 채팅 API
  - `menu/`: 메뉴 API
  - `resume/`: 이력서 데이터 API (education, experience, hobbies, profile, projects, skills 등)

### Supabase Edge Functions
- `supabase/functions/_shared/`: 공유 모듈 (배포 안됨)
  - `component-mapper.ts`: 컴포넌트 타입 매핑
  - `rag.ts`: RAG 로직
  - `ai-provider.ts`: AI 프로바이더 추상화
  - `history-optimizer.ts`: 대화 기록 최적화
  - `url-fetcher.ts`: URL 페처 유틸리티
  - `supabase.ts`: Supabase 클라이언트
  - `types.ts`: 타입 정의
- `supabase/functions/dewdew-rag-portfolio/`: 배포되는 함수
- TypeScript로 작성

## 성능 최적화

### 이미지
- `@nuxt/image` 사용으로 자동 최적화
- WebP/AVIF 포맷 지원
- Lazy loading 적용

### 번들 최적화
- Tree shaking 활성화
- Dynamic import 사용
- 코드 스플리팅

### 스크롤 최적화
- `flex-1 min-h-0` 패턴으로 높이 제한
- `overflow-hidden` / `overflow-y-auto` 적절히 사용
- 스트리밍 중 DOM 조작 최소화

### PWA 최적화
- Service Worker 기반 캐싱 전략
- 이미지: CacheFirst (30일)
- 폰트: CacheFirst (1년)
- API: NetworkFirst (5분~1시간)
- 정적 자산: StaleWhileRevalidate (7일)

### 분석 및 모니터링
- Vercel Analytics: 프로덕션 환경에서만 활성화 (`import.meta.env.VERCEL`)
- Speed Insights: Core Web Vitals 실시간 모니터링

## Plugins

### 클라이언트 플러그인
- `app/plugins/analytics.client.ts`: Vercel Analytics (프로덕션 환경에서만 활성화)
- `app/plugins/senitize.ts`: DOMPurify를 통한 HTML 정제 (XSS 방지)

### 플러그인 규칙
- `.client.ts` 접미사로 클라이언트 전용 플러그인 명시
- 서버에서 실행되면 안 되는 코드는 클라이언트 플러그인으로 분리

## 에러 처리

### 클라이언트
- `app/error.vue`: 전역 에러 페이지
- `app/components/chat/Error.server.vue`: 채팅 에러 컴포넌트
- Try-catch로 에러 핸들링

### 서버
- Supabase Edge Functions에서 에러 응답 처리
- 적절한 HTTP 상태 코드 반환

## 개발 워크플로우

### 환경 변수
- `.env` 파일에 필수 변수 설정
- 필수 변수:
  - `SUPABASE_URL`, `SUPABASE_KEY` (Supabase 연결)
  - `OPENAI_API_KEY` (AI 채팅 기능용)
- 선택 변수:
  - `EMAILJS_KEY`, `EMAILJS_TEMPLATE` (연락 폼용)
  - `DATA_PORTAL_API_KEY` (기상청 API용)
  - `NUXT_PUBLIC_SITE_URL` (SEO용)

### 빌드 및 배포
- 개발: `bun dev` (포트: 4110)
- 빌드: `bun build`
- Supabase Functions 배포: `bun run supabase:deploy`

### 버전 관리
- `scripts/version-manager.js`로 버전 관리
- `bun run version:patch|minor|major`

## 보안

### XSS 방지
- `vue-dompurify-html` 플러그인으로 HTML 정제
- 사용자 입력은 항상 DOMPurify를 통해 정제
- `v-html` 사용 시 주의 (가능하면 피하기)

### 입력 검증
- Yup을 통한 폼 유효성 검사
- `useValidation` composable 활용
- 서버 측 검증도 필수

## 주의사항

1. **Nuxt UI 프리픽스**: 모든 Nuxt UI 컴포넌트는 `Dd` 프리픽스 사용
2. **서버/클라이언트 컴포넌트**: `.server.vue` / `.client.vue` 접미사 명시
3. **타입 안전성**: `any` 타입 사용 지양, 제네릭 타입 활용
4. **성능**: 스트리밍 중 DOM 조작 최소화
5. **다국어**: 모든 사용자에게 보이는 텍스트는 i18n 사용
6. **Analytics**: 프로덕션 환경에서만 활성화 (`import.meta.env.VERCEL` 체크)
7. **HTML 정제**: 사용자 입력 HTML은 반드시 DOMPurify 사용

## 참고 자료
- [Nuxt 4 문서](https://nuxt.com/)
- [Nuxt UI 문서](https://ui.nuxt.com/)
- [Supabase 문서](https://supabase.com/docs)
- [Vue 3 문서](https://vuejs.org/)

